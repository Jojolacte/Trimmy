name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  lint-build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16.1 (Sequoia SDK)
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app
          echo "DEVELOPER_DIR=/Applications/Xcode_16.1.app/Contents/Developer" >> "$GITHUB_ENV"

      - name: Install Swift 6.2 toolchain
        run: |
          curl -L https://download.swift.org/swift-6.2-release/xcode/swift-6.2-RELEASE/swift-6.2-RELEASE-osx.pkg -o /tmp/swift.pkg
          sudo installer -pkg /tmp/swift.pkg -target /
          echo "/Library/Developer/Toolchains/swift-6.2-RELEASE.xctoolchain/usr/bin" >> "$GITHUB_PATH"
          echo "TOOLCHAINS=swift-6.2-RELEASE" >> "$GITHUB_ENV"

      - name: Install lint tools
        run: brew install swiftlint swiftformat

      - name: SwiftFormat (lint)
        run: swiftformat Sources Tests --lint

      - name: SwiftLint
        run: swiftlint --strict

      - name: Swift Test
        run: swift test --parallel
